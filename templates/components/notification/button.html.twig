{# Renders round profile button with initials and unread badge #}
{% set initials = (app.user and app.user.name is defined and app.user.name ? app.user.name : app.user.email)|split(' ')|map(v => v|first)|join('')|slice(0,2)|upper %}
<details id="notif-details" class="relative">
  <summary id="notif-btn" class="list-none cursor-pointer">
    <div class="relative inline-flex items-center justify-center h-10 w-10 rounded-full bg-primary text-primary-foreground">
      <span class="font-medium">{{ initials ?: 'ME' }}</span>
      <span id="notif-badge"
            class="absolute -top-1 -right-1 hidden min-w-5 h-5 px-1 rounded-full bg-red-600 text-white text-xs flex items-center justify-center"></span>
    </div>
  </summary>
  <div id="notif-tray" class="absolute right-0 mt-2 w-80 bg-white border rounded-md shadow-lg z-50">
    <div class="px-3 py-2 text-sm font-medium text-muted-foreground border-b flex items-center gap-2">
        <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor"
             stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M6 8a6 6 0 0 1 12 0c0 7 3 9 3 9H3s3-2 3-9"/>
            <path d="M10.3 21a1.94 1.94 0 0 0 3.4 0"/>
        </svg>
        {{ 'notifications.title'|trans }}
    </div>
    <div id="notif-list" class="max-h-64 overflow-y-auto p-2 space-y-1">
        <div class="text-sm text-muted-foreground p-2">{{ 'notifications.loading'|trans }}</div>
    </div>
    <div class="border-t px-3 py-2 flex items-center gap-3">
        <div class="w-8 h-8 rounded-full bg-primary text-primary-foreground flex items-center justify-center text-sm font-medium">{{ initials ?: 'ME' }}</div>
        <div class="flex-1 min-w-0">
            <div class="text-sm font-medium text-workshop-brown truncate">{{ app.user.name ?? app.user.email }}</div>
            <div class="text-xs text-muted-foreground truncate">{{ app.user.email }}</div>
        </div>
    </div>
    <div class="border-t p-1 text-sm">
        <a class="flex items-center gap-2 px-2 py-2 rounded hover:bg-muted/50 text-workshop-brown"
           href="{{ path('dashboard') }}">
            <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4" viewBox="0 0 24 24" fill="none"
                 stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M3 3h7v7H3z"/>
                <path d="M14 3h7v7h-7z"/>
                <path d="M14 14h7v7h-7z"/>
                <path d="M3 14h7v7H3z"/>
            </svg>
            {{ 'notifications.my_bookings'|trans }}
        </a>
        <a class="flex items-center gap-2 px-2 py-2 rounded hover:bg-muted/50 text-workshop-brown"
           href="{{ path('profile') }}">
            <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4" viewBox="0 0 24 24" fill="none"
                 stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/>
                <circle cx="12" cy="7" r="4"/>
            </svg>
            {{ 'notifications.profile_settings'|trans }}
        </a>
        {% if is_granted('ROLE_ADMIN') %}
            <a class="flex items-center gap-2 px-2 py-2 rounded hover:bg-muted/50 text-workshop-brown"
               href="{{ path('app_admin_dashboard') }}">
                <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4" viewBox="0 0 24 24" fill="none"
                     stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M12 2v20"/>
                    <path d="M2 12h20"/>
                </svg>
                {{ 'notifications.admin_panel'|trans }}
            </a>
        {% endif %}

        {# Impersonation controls #}
        {% if is_granted('IS_IMPERSONATOR') %}
            <a class="flex items-center gap-2 px-2 py-2 rounded hover:bg-green-50 text-green-700"
               href="{{ path('homepage', {'_switch_user': '_exit'}) }}" data-turbo="false">
                <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4" viewBox="0 0 24 24" fill="none"
                     stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <polyline points="15 3 21 3 21 9"/>
                    <path d="M10 14 21 3"/>
                    <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V7a2 2 0 0 1 2-2h4"/>
                </svg>
                {{ 'notifications.stop_impersonation'|trans }}
            </a>
        {% elseif is_granted('ROLE_ADMIN') %}
            <button id="impersonate-btn"
                    class="w-full flex items-center gap-2 px-2 py-2 rounded hover:bg-muted/50 text-workshop-brown">
                <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4 shrink-0 relative top-px" viewBox="0 0 24 24"
                     fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M2 9s3-4 10-4 10 4 10 4-3 4-10 4S2 9 2 9Z"/>
                    <path d="M8 10h.01"/>
                    <path d="M16 10h.01"/>
                </svg>
                {{ 'notifications.impersonate'|trans }}
            </button>
            <div id="impersonate-box" class="mt-2 hidden">
                <input id="impersonate-input" type="text" class="w-full rounded border px-2 py-1 text-sm"
                       placeholder="{{ 'notifications.impersonate_placeholder'|trans }}" autocomplete="off">
                <div id="impersonate-suggestions"
                     class="mt-1 max-h-56 overflow-auto rounded border bg-white shadow hidden"></div>
            </div>
        {% endif %}

        <a class="flex items-center gap-2 px-2 py-2 rounded hover:bg-red-50 text-red-600"
           href="{{ path('app_logout') }}">
            <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4" viewBox="0 0 24 24" fill="none"
                 stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/>
                <polyline points="16 17 21 12 16 7"/>
                <line x1="21" y1="12" x2="9" y2="12"/>
            </svg>
            {{ 'notifications.logout'|trans }}
        </a>
    </div>
  </div>
</details>
