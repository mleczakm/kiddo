<div {{ attributes }}>
    <h2 class="text-2xl font-bold mb-4 font-display text-workshop-brown">{{ 'page.my_bookings'|trans }}</h2>
    <div dir="ltr" data-orientation="horizontal">
        <div role="tablist" aria-orientation="horizontal"
             class="inline-flex h-10 items-center justify-center rounded-md bg-muted p-1 text-muted-foreground w-full mb-6"
             tabindex="0" data-orientation="horizontal" style="outline: none;">
            <button type="button" role="tab"
                    aria-selected="{{ activeTab == 'active' ? 'true' : 'false' }}"
                    data-state="{{ activeTab == 'active' ? 'active' : 'inactive' }}"
                    data-action="live#action"
                    data-live-action-param="selectTab"
                    data-live-tab-param="active"
                    class="inline-flex items-center justify-center whitespace-nowrap rounded-sm px-3 py-1.5 text-sm font-medium ring-offset-background transition-all focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 data-[state=active]:bg-background data-[state=active]:text-foreground data-[state=active]:shadow-sm flex-1"
                    data-orientation="horizontal">
                {{ 'dashboard.active_bookings'|trans }}
            </button>
            <button type="button" role="tab"
                    aria-selected="{{ activeTab == 'past' ? 'true' : 'false' }}"
                    data-state="{{ activeTab == 'past' ? 'active' : 'inactive' }}"
                    data-action="live#action"
                    data-live-action-param="selectTab"
                    data-live-tab-param="past"
                    class="inline-flex items-center justify-center whitespace-nowrap rounded-sm px-3 py-1.5 text-sm font-medium ring-offset-background transition-all focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 data-[state=active]:bg-background data-[state=active]:text-foreground data-[state=active]:shadow-sm flex-1"
                    data-orientation="horizontal">
                {{ 'dashboard.past_bookings'|trans }}
            </button>
            <button type="button" role="tab"
                    aria-selected="{{ activeTab == 'cancelled' ? 'true' : 'false' }}"
                    data-state="{{ activeTab == 'cancelled' ? 'active' : 'inactive' }}"
                    data-action="live#action"
                    data-live-action-param="selectTab"
                    data-live-tab-param="cancelled"
                    class="inline-flex items-center justify-center whitespace-nowrap rounded-sm px-3 py-1.5 text-sm font-medium ring-offset-background transition-all focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 data-[state=active]:bg-background data-[state=active]:text-foreground data-[state=active]:shadow-sm flex-1"
                    data-orientation="horizontal">
                {{ 'dashboard.cancelled_bookings'|trans }}
            </button>
        </div>

        {# Active Bookings Tab Panel #}
        <div data-state="active" data-orientation="horizontal" role="tabpanel"
             aria-labelledby="active-tab" id="active-bookings" tabindex="0"
             class="mt-2 ring-offset-background focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2">
            <div class="space-y-4">
                {% for booking in this.getCurrentBookings %}
                    {% for lesson in booking.lessons %}
                        {% set isCancelled = booking.lessonsMap.isCancelledLesson(lesson.id) %}
                        {% set isRescheduled = booking.lessonsMap.isRescheduledLesson(lesson.id) %}
                        {% set isFuture = lesson.metadata.schedule > date() %}
                        {% set show =
                            (activeTab == 'cancelled' and isCancelled) or
                            (activeTab == 'active' and (not isCancelled) and isFuture) or
                            (activeTab == 'past' and (not isCancelled) and (not isFuture))
                        %}
                        {% if show %}
                        <div class="rounded-lg border bg-card text-card-foreground shadow-sm overflow-hidden {{ isCancelled ? 'opacity-70' : '' }}">
                            <div class="flex flex-col md:flex-row">
                                <div class="p-6 flex-grow">
                                    <div class="flex justify-between items-start">
                                        <div>
                                            <h3 class="font-bold text-lg mb-1 {{ isCancelled ? 'line-through text-muted-foreground' : '' }}">{{ lesson.metadata.title }}</h3>
                                            <p class="text-sm text-muted-foreground">{{ 'dashboard.single_entry'|trans }}</p>
                                        </div>
                                        <div class="text-right min-w-[80px] flex flex-col items-end gap-2">
                                            {% if booking.payment %}
                                                {% set statusClass =
                                                    booking.payment.status == 'paid' ? 'border-green-600 bg-green-600 text-white' :
                                                    (booking.payment.status == 'pending' ? 'border-yellow-500 bg-yellow-500 text-white' :
                                                    (booking.payment.status == 'failed' ? 'border-red-600 bg-red-600 text-white' :
                                                    (booking.payment.status == 'refunded' ?  'border-blue-600 bg-blue-600 text-white' :
                                                    'border-gray-400 bg-gray-200 text-gray-700'))) %}
                                                <div class="flex gap-2 items-center">
                                                    <div class="inline-flex items-center rounded-full border px-2.5 py-0.5 text-xs font-semibold transition-colors focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 {{ statusClass }}">
                                                        {{ ('dashboard.payment.' ~ booking.payment.status)|trans }}
                                                    </div>
                                                    {% if booking.lessons|length > 1 %}
                                                        <div class="inline-flex items-center rounded-full border px-2.5 py-0.5 text-xs font-semibold transition-colors focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 border-workshop-blue text-workshop-blue">
                                                            {{ 'dashboard.booking.carnet'|trans }}</div>
                                                    {% endif %}
                                                </div>
                                                <span class="font-medium text-lg text-workshop-brown">
                                                    {{ booking.payment.amount|money }}
                                                </span>
                                            {% endif %}
                                            <div class="text-xs">
                                                {{ booking.createdAt|date('d.m.Y H:i') }}
                                            </div>
                                        </div>
                                    </div>
                                    <div class="mt-4 space-y-2">
                                        <div class="flex items-center space-x-2 text-sm">
                                            <div class="flex items-center {{ isCancelled ? 'line-through text-muted-foreground' : '' }}">
                                                <svg xmlns="http://www.w3.org/2000/svg" width="16"
                                                     height="16" viewBox="0 0 24 24" fill="none"
                                                     stroke="currentColor" stroke-width="2"
                                                     stroke-linecap="round" stroke-linejoin="round"
                                                     class="lucide lucide-calendar w-4 h-4 mr-1 text-workshop-red">
                                                    <path d="M8 2v4"></path>
                                                    <path d="M16 2v4"></path>
                                                    <rect width="18" height="18" x="3" y="4"
                                                          rx="2"></rect>
                                                    <path d="M3 10h18"></path>
                                                </svg>
                                                <span>{{ lesson.metadata.schedule|date('d.m.Y') }}</span>
                                            </div>
                                            <div class="flex items-center {{ isCancelled ? 'line-through text-muted-foreground' : '' }}">
                                                <svg xmlns="http://www.w3.org/2000/svg" width="16"
                                                     height="16" viewBox="0 0 24 24" fill="none"
                                                     stroke="currentColor" stroke-width="2"
                                                     stroke-linecap="round" stroke-linejoin="round"
                                                     class="lucide lucide-clock w-4 h-4 mr-1 text-workshop-red">
                                                    <circle cx="12" cy="12" r="10"></circle>
                                                    <polyline points="12 6 12 12 16 14"></polyline>
                                                </svg>
                                                <span>{{ lesson.metadata.schedule|date('H:i') }} - {{ lesson.metadata.schedule|date_modify('+' ~ lesson.metadata.duration ~ ' minutes')|date('H:i') }}</span>
                                                {% if isCancelled %}
                                                    <span class="ml-2 inline-flex items-center rounded-full bg-red-50 text-red-700 px-2.5 py-0.5 text-xs font-semibold border border-red-200">
                                                        {{ isRescheduled ? 'rescheduled' : 'cancelled' }}
                                                    </span>
                                                {% endif %}
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="p-6 flex items-center justify-center md:w-60">
                                    {% set canModify = (not isCancelled) and (not isRescheduled) and isFuture %}
                                    {% if canModify and lesson.cancellationAvailable() %}
                                        {{ component('BookingCancellationModal', {booking: booking, lesson: lesson}) }}
                                    {% else %}
                                        <span class="text-sm text-muted-foreground text-center">
                                            {{ 'booking.cancellation_not_available'|trans }}
                                        </span>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        {% endif %}
                    {% endfor %}
                {% else %}
                    <div class="text-center py-8 text-muted-foreground">
                        <p>{{ 'dashboard.no_active_bookings'|trans }}</p>
                        <a href="{{ path('workshops') }}"
                           class="text-workshop-red hover:underline mt-2 inline-block">
                            {{ 'dashboard.browse_workshops'|trans }}
                        </a>
                    </div>
                {% endfor %}
            </div>
        </div>
    </div>
</div>
